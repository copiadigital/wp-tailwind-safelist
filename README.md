# WP Tailwind Safelist

Automatically creates a Tailwind CSS safelist from WordPress content including Gutenberg blocks, ACF fields (flexible content, repeaters, groups), Contact Form 7 forms, and more.

Built for [Sage](https://roots.io/sage) themes using [Acorn](https://roots.io/acorn).

## Requirements

- PHP >= 8.1 with `exec()` enabled
- [Acorn](https://roots.io/acorn) >= 4.0
- [Sage](https://roots.io/sage) >= 10.0

**Note:** Node.js is NOT required on the server. This package includes standalone yarn binaries.

## Bundled Binaries

This package is fully self-contained with bundled executables:

| File | Purpose |
|------|---------|
| `yarn-linux` | Standalone yarn for Linux servers |
| `yarn-macos` | Standalone yarn for macOS |
| `wp-cli.phar` | WP-CLI for triggering builds |

No external dependencies needed - works on any server with PHP.

## Installation

Add the repository to your theme's `composer.json`:

```json
{
  "repositories": {
    "wp-tailwind-safelist": {
      "type": "vcs",
      "url": "git@github.com:copiadigital/wp-tailwind-safelist.git"
    }
  }
}
```

Install via Composer:

```bash
composer require copiadigital/wp-tailwind-safelist
```

## Setup

### 1. Register the service provider

Add the service provider to your theme's `composer.json`:

```json
{
  "extra": {
    "acorn": {
      "providers": [
        "App\\Providers\\ThemeServiceProvider",
        "CopiaDigital\\TailwindSafelist\\TailwindSafelistServiceProvider"
      ]
    }
  }
}
```

Then run:

```bash
composer dump-autoload
wp acorn optimize:clear
```

### 2. Create the database table

```bash
wp acorn tailwind:update-db
```

### 3. Configure your Tailwind config

Add the following to your `tailwind.config.js`:

```js
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get safelist classes from file (generated by wp-tailwind-safelist)
const __dirname = path.dirname(fileURLToPath(import.meta.url));
const safelistFile = path.resolve(__dirname, 'tailwind-safelist.txt');
const safelistClasses = (() => {
  if (!fs.existsSync(safelistFile)) return [];
  const classesString = fs.readFileSync(safelistFile, 'utf8');
  if (!classesString) return [];
  const classesBuffer = Buffer.from(classesString, 'base64');
  return classesBuffer.toString().split(' ').filter(Boolean);
})();

/** @type {import('tailwindcss').Config} */
export default {
  // ... your config

  safelist: [
    // Dynamic classes from WordPress content
    ...safelistClasses,

    // Your other safelist entries...
  ],
}
```

### 4. Run the initial scan

```bash
wp acorn tailwind:scan
```

### 5. Rebuild your assets

```bash
yarn build
```

## Usage

### Admin Bar Button

A **"Re-process Tailwind"** button appears in the WordPress admin bar for administrators. Click it to:

1. Scan all content for CSS classes
2. Update the safelist file
3. Automatically trigger `yarn build` via WP-CLI

**Security:**
- Only visible to users with `manage_options` capability (Administrators)
- Protected by WordPress nonce verification
- Works in all environments (development, staging, production)

### CLI Commands

#### Scan and build

Scans all content and triggers a build:

```bash
wp acorn tailwind:scan
```

#### Scan only (no build)

```bash
wp acorn tailwind:scan --no-build
```

#### Build only

Run the yarn build using the standalone binary:

```bash
wp acorn tailwind:build
```

#### Development build

```bash
wp acorn tailwind:build --dev
```

#### Scan specific post types

```bash
wp acorn tailwind:scan --post-types=post --post-types=page
```

#### Include Blade template scanning

```bash
wp acorn tailwind:scan --include-templates
```

#### Update database table

```bash
wp acorn tailwind:update-db
```

## How It Works

### When you click "Re-process Tailwind"

```
Click button
    |
    v
PHP scans all content for CSS classes
    |
    v
Saves classes to database and tailwind-safelist.txt
    |
    v
Calls: php wp-cli.phar acorn tailwind:build --allow-root
    |
    v
BuildCommand detects OS (Linux/macOS)
    |
    v
Executes: ./yarn-linux build (or ./yarn-macos)
    |
    v
Tailwind CSS rebuilt with new classes
```

### Content sources scanned

- **All post types** - Posts, pages, custom post types
- **Contact Form 7** - Form templates and mail templates
- **ACF Fields** - Including:
  - Flexible Content layouts
  - Repeater fields
  - Group fields
  - All nested fields
  - Fields with class-related names (automatically detected)
- **ACF Options Pages** - All registered options pages
- **Widgets** - All widget settings

With `--include-templates` option:
- **Blade Templates** - All `.blade.php` files in `resources/views`

## Configuration

Publish the config file:

```bash
wp acorn vendor:publish --provider="CopiaDigital\TailwindSafelist\TailwindSafelistServiceProvider"
```

### Config options

```php
// config/tailwind-safelist.php

return [
    // Output file path
    'output_path' => get_stylesheet_directory() . '/tailwind-safelist.txt',

    // Patterns to exclude (regex)
    'exclude_patterns' => [
        '/^wp-/',      // WordPress classes
        '/^wpcf7/',    // Contact Form 7 classes
        // Add your own patterns...
    ],

    // Field names that contain CSS classes
    'class_field_patterns' => [
        'class',
        'classes',
        'custom_class',
        'tailwind',
        // Add your own patterns...
    ],

    // Custom build command (optional)
    // If not set, uses bundled wp-cli.phar and yarn binaries
    'build_command' => null,
];
```

## Server Requirements

| Environment | Requirements |
|-------------|--------------|
| **Any server** | PHP 8.1+ with `exec()` enabled |
| **Docker** | Works automatically |
| **Staging/Production** | No Node.js needed (standalone binaries) |

## Cross-Platform Compatibility

The build process automatically handles file permissions across different environments:

| Server Type | Web User | Supported |
|-------------|----------|-----------|
| Debian/Ubuntu | `www-data` | ✅ |
| RHEL/CentOS | `apache` | ✅ |
| Amazon Linux | `ec2-user` | ✅ |
| Nginx | `nginx` | ✅ |
| macOS | `_www` | ✅ |
| Docker | `root` | ✅ |

The package automatically sets appropriate file permissions on the `public/build` directory to prevent `EACCES` permission errors when builds run from different contexts (PHP container, node container, host machine).

## Security

The admin bar button and AJAX endpoint are protected by:

1. **Capability check**: `current_user_can('manage_options')` - Administrators only
2. **Nonce verification**: `check_ajax_referer()` - CSRF protection
3. **Input sanitization**: All shell arguments use `escapeshellarg()`

## Changelog

See [CHANGELOG.md](CHANGELOG.md) for version history and updates.

## License

MIT License - see [LICENSE](LICENSE) for details.
