# WP Tailwind Safelist

Automatically creates a Tailwind CSS safelist from WordPress content including Gutenberg blocks, ACF fields (flexible content, repeaters, groups), Contact Form 7 forms, and more.

Built for [Sage](https://roots.io/sage) themes using [Acorn](https://roots.io/acorn).

## Requirements

- PHP >= 8.1
- [Acorn](https://roots.io/acorn) >= 4.0
- [Sage](https://roots.io/sage) >= 10.0
- Node.js (for the build watcher)

## Installation

Add the repository to your theme's `composer.json`:

```json
{
  "repositories": {
    "wp-tailwind-safelist": {
      "type": "vcs",
      "url": "git@github.com:copiadigital/wp-tailwind-safelist.git"
    }
  }
}
```

Install via Composer:

```bash
composer require copiadigital/wp-tailwind-safelist
```

## Setup

### 1. Register the service provider

Add the service provider to your theme's `composer.json`:

```json
{
  "extra": {
    "acorn": {
      "providers": [
        "App\\Providers\\ThemeServiceProvider",
        "CopiaDigital\\TailwindSafelist\\TailwindSafelistServiceProvider"
      ]
    }
  }
}
```

Then run:

```bash
composer dump-autoload
wp acorn optimize:clear
```

### 2. Create the database table

```bash
wp acorn tailwind:update-db
```

### 3. Configure your Tailwind config

Add the following to your `tailwind.config.js`:

```js
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get safelist classes from file (generated by wp-tailwind-safelist)
const __dirname = path.dirname(fileURLToPath(import.meta.url));
const safelistFile = path.resolve(__dirname, 'tailwind-safelist.txt');
const safelistClasses = (() => {
  if (!fs.existsSync(safelistFile)) return [];
  const classesString = fs.readFileSync(safelistFile, 'utf8');
  if (!classesString) return [];
  const classesBuffer = Buffer.from(classesString, 'base64');
  return classesBuffer.toString().split(' ').filter(Boolean);
})();

/** @type {import('tailwindcss').Config} */
export default {
  // ... your config

  safelist: [
    // Dynamic classes from WordPress content
    ...safelistClasses,

    // Your other safelist entries...
  ],
}
```

### 4. Run the initial scan

```bash
wp acorn tailwind:scan
```

### 5. Rebuild your assets

```bash
yarn build
```

## Usage

### Admin Bar (Development Only)

In development environments (`WP_ENV=development`), a **"Re-process Tailwind"** button appears in the WordPress admin bar. Click it to:

1. Scan all content for CSS classes
2. Update the safelist file
3. Optionally trigger a build (if configured)

This provides a quick way to update the safelist without using the command line.

### CLI Commands

#### Scan all content

Scans all posts, pages, ACF fields, CF7 forms, and widgets (templates are skipped by default):

```bash
wp acorn tailwind:scan
```

#### Watch for changes

Start the build watcher to automatically trigger `yarn build` when the safelist is updated:

```bash
wp acorn tailwind:watch
```

#### Scan specific post types

```bash
wp acorn tailwind:scan --post-types=post --post-types=page
```

#### Include Blade template scanning

To also scan Blade templates for classes:

```bash
wp acorn tailwind:scan --include-templates
```

## How it works

### Automatic detection on save

When you save a post, page, or CF7 form in the WordPress admin, the plugin automatically:

1. Extracts all CSS classes from the content
2. Stores them in the database
3. Updates the `tailwind-safelist.txt` file

### Manual scanning

The `tailwind:scan` command scans the following by default:

- **All post types** - Posts, pages, custom post types
- **Contact Form 7** - Form templates and mail templates
- **ACF Fields** - Including:
  - Flexible Content layouts
  - Repeater fields
  - Group fields
  - All nested fields
  - Fields with class-related names (automatically detected)
- **ACF Options Pages** - All registered options pages
- **Widgets** - All widget settings

With `--include-templates` option:
- **Blade Templates** - All `.blade.php` files in `resources/views`

## Configuration

Publish the config file:

```bash
wp acorn vendor:publish --provider="CopiaDigital\TailwindSafelist\TailwindSafelistServiceProvider"
```

### Config options

```php
// config/tailwind-safelist.php

return [
    // Auto-scan on post save (disabled by default)
    // Set to true to automatically scan when posts are saved
    'auto_scan_on_save' => false,

    // Output file path
    'output_path' => get_stylesheet_directory() . '/tailwind-safelist.txt',

    // Patterns to exclude (regex)
    'exclude_patterns' => [
        '/^wp-/',      // WordPress classes
        '/^wpcf7/',    // Contact Form 7 classes
        // Add your own patterns...
    ],

    // Field names that contain CSS classes
    'class_field_patterns' => [
        'class',
        'classes',
        'custom_class',
        'tailwind',
        // Add your own patterns...
    ],

    // Build trigger file for auto-build (development only)
    'build_trigger_file' => get_stylesheet_directory() . '/.tailwind-build-trigger',
];
```

### Auto-build with file watcher

To automatically run `yarn build` when the safelist is updated via the admin bar:

1. Set `build_trigger_file` in your config
2. Run the build watcher:

```bash
wp acorn tailwind:watch
```

This will watch for safelist changes and automatically trigger `yarn build` when updates occur.

## License

MIT License - see [LICENSE](LICENSE) for details.
